YUI.add("moodle-atto_mathslate-mathjaxeditor",function(f,e){var v,E,S,A;M.atto_mathslate=M.atto_mathslate||{},v=M&&M.atto_mathslate||{},S="."+(E={SELECTED:"mathslate-selected",WORKSPACE:"mathslate-workspace",PREVIEW:"mathslate-preview",HIGHLIGHT:"mathslate-highlight",DRAGNODE:"mathslate-workspace-drag",DRAGGEDNODE:"mathslate-workspace-dragged",HELPBOX:"mathslate-help-box",PANEL:"mathslate-bottom-panel"}).SELECTED,A="."+E.HIGHLIGHT,v.MathJaxEditor=function(t){var e,i,o,d,a,c,g,u,p,n=window.MathJax,s=[],r=new v.mSlots;function h(){(e=f.Node.create("<span></span>")).setHTML(r.preview().replace(/div/g,"span").replace(/<\/*br>/g,"")),f.one(t).appendChild(e),e.all("span").each(function(e){a.get("node").one("#"+e.getAttribute("id"))&&(e.appendChild('<span style="position: relative; opacity: 0"><math display="inline">'+b([f.JSON.parse(r.getItemByID(e.getAttribute("id")))]).replace(/id="[^"]*"/,"")+"</math></span>"),e.setAttribute("style","position: absolute; top: 0; left: 0; margin: 0px; z-index: +1"))}),e.all("span").each(function(e){var t,o;a.get("node").one("#"+e.getAttribute("id"))&&(t=a.get("node").one("#"+e.getAttribute("id")).getDOMNode().getBoundingClientRect(),o=e.getDOMNode().getBoundingClientRect(),e.setStyle("top",t.top-o.top),e.setStyle("left",t.left-o.left),e.setStyle("width",t.width),e.setStyle("height",t.height))}),n.Hub.Queue(["Typeset",n.Hub,e.getDOMNode()])}function m(){e&&e.remove(),h(),i=e,d.setHTML('<div class="'+E.PREVIEW+'">'+r.preview("tex")+"</div>"),r.getSelected()&&d.one("#"+r.getSelected())&&(a.get("node").one("#"+r.getSelected()).addClass(E.SELECTED),a.get("node").one("#"+r.getSelected()).setAttribute("mathcolor","green"),a.get("node").one("#"+r.getSelected()).setAttribute("stroke","green"),a.get("node").one("#"+r.getSelected()).setAttribute("fill","green"),d.one("#"+r.getSelected()).addClass(E.SELECTED)),r.forEach(function(o){var e,n=i.one("#"+o[1].id);n&&(n.setAttribute("title",d.one("#"+o[1].id).getHTML().replace(/<div *[^>]*>|<\/div>|<br>/g,"")),n.handleClick=function(e){var t=i.one("#"+r.getSelected());return t?t===n?d.one("#"+n.getAttribute("id")).test("."+E.PREVIEW+" >")?(r.select(),void l()):(n.removeClass(E.SELECTED),d.one("#"+n.getAttribute("id")).removeClass(E.SELECTED),a.get("node").one("#"+r.getSelected()).removeAttribute("mathcolor"),a.get("node").one("#"+r.getSelected()).removeAttribute("stroke"),a.get("node").one("#"+r.getSelected()).removeAttribute("fill"),void r.select()):void(t.one("#"+this.getAttribute("id"))||(e.stopPropagation(),r.insertSnippet(n.getAttribute("id"),r.removeSnippet(t.getAttribute("id"))),r.select(),l())):(e.stopPropagation(),r.select(this.getAttribute("id")),void l())},n.on("click",function(e){this.handleClick(e)}),e=i.one("#"+r.getSelected()),o[1]&&o[1]["class"]&&"blank"===o[1]["class"]||e&&d.one("#"+r.getSelected()).one("#"+o[1].id)||((e=new f.DD.Drag({node:n,moveOnEnd:!1})).on("drag:start",function(){a.get("node").one("#"+r.getSelected())&&(d.one("#"+r.getSelected()).removeClass(E.SELECTED),a.get("node").one("#"+r.getSelected()).removeClass(E.SELECTED),a.get("node").one("#"+r.getSelected()).removeAttribute("mathcolor"),a.get("node").one("#"+r.getSelected()).removeAttribute("stroke"),a.get("node").one("#"+r.getSelected()).removeAttribute("fill"),r.select()),this.get("node").addClass(E.DRAGGEDNODE),this.get("node").setAttribute("mathcolor","red"),i.one("#"+o[1].id).setAttribute("mathcolor","red"),i.one("#"+o[1].id).setAttribute("stroke","red"),this.get("dragNode").addClass(E.DRAGNODE),this.get("dragNode").all("> span").pop().setStyle("opacity","1")}),e.on("drag:end",function(){this.get("node").removeClass(E.DRAGGEDNODE),this.get("node").removeAttribute("mathcolor"),this.get("node").removeAttribute("stroke"),this.get("dragNode").all("> span").pop().setStyle("opacity","0"),this.get("dragNode").setStyles({top:0,left:0})})),(e=new f.DD.Drop({node:n})).on("drop:hit",function(e){var t=e.drag.get("node").get("id");e.drag.get("data")?r.insertSnippet(o[1].id,r.createItem(e.drag.get("data"))):t!==o[1].id&&r.isItem(t)&&!d.one("#"+t).one("#"+o[1].id)&&r.insertSnippet(e.drop.get("node").get("id"),r.removeSnippet(t)),l()}),e.on("drop:enter",function(e){e.stopPropagation(),i.all(t+" "+A).each(function(e){e.removeClass(E.HIGHLIGHT);e=e.getAttribute("id");a.get("node").one(e)&&(a.get("node").one(e).removeClass(E.HIGHLIGHT),a.get("node").one(e).removeAttribute("mathcolor"),a.get("node").one(e).removeAttribute("stroke"),a.get("node").one(e).removeAttribute("fill"))}),i.one("#"+o[1].id).addClass(E.HIGHLIGHT),a.get("node").one("#"+o[1].id).addClass(E.HIGHLIGHT),a.get("node").one("#"+o[1].id).setAttribute("mathcolor","yellow"),a.get("node").one("#"+o[1].id).setAttribute("stroke","yellow"),a.get("node").one("#"+o[1].id).setAttribute("fill","yellow")}),e.on("drop:exit",function(e){e.stopPropagation(),this.get("node").removeClass(E.HIGHLIGHT),a.get("node").one("#"+o[1].id).removeClass(E.HIGHLIGHT),a.get("node").one("#"+o[1].id).removeAttribute("mathcolor"),a.get("node").one("#"+o[1].id).removeAttribute("stroke"),a.get("node").one("#"+o[1].id).removeAttribute("fill")}))})}function b(e){if("object"!=typeof e)return e;var o="";return e.forEach(function(e){if("object"==typeof e){if(o+="<"+e[0],e[1]&&"object"==typeof e[1])for(var t in e[1])"object"!=typeof e[1][t]&&(o+=" "+t+'="'+e[1][t]+'"');o+=">",e[2]&&(o+=b(e[2])),o+="</"+e[0]+">"}}),o}function l(){r.rekey();var e=n.Hub.getAllJax(a.get("node").getDOMNode())[0];e?n.Hub.Queue(function(){n.Hub.Queue(["Text",e,"<math>"+b(s)+"</math>"]),n.Hub.Queue(m)}):(a.get("node").setHTML(""),n.Hub.Queue(["addElement",n.HTML,a.get("node").getDOMNode(),"math",{display:"block"},s]),n.Hub.Queue(["Typeset",n.Hub,a.get("node").getDOMNode()]),n.Hub.Queue(m))}r.slots.push(s),this.workspace=f.one(t).append('<div id="canvas" class="'+E.WORKSPACE+'"/>'),o=f.one(t).appendChild(f.Node.create("<form></form>")),(d=f.one(t).appendChild(f.Node.create('<div class="'+E.PANEL+'"/>'))).delegate("click",function(e){i.one(
"#"+this.getAttribute("id")).handleClick(e)},"div"),a=new f.DD.Drop({node:this.workspace.one("#canvas")}),this.canvas=a,this.canvas.get("node").on("click",function(){r.select(),l()}),c=f.Node.create('<button type="button" class="'+E.UNDO+'"" title="'+M.util.get_string("undo","atto_mathslate")+'"/><math><mo>&#x25C1;</mo></math></button>'),g=f.Node.create('<button type="button" class="'+E.REDO+'"" title="'+M.util.get_string("redo","atto_mathslate")+'"/><math><mo>&#x25B7;</mo></math></button>'),u=f.Node.create('<button type="button" class="'+E.CLEAR+'"" title="'+M.util.get_string("clear","atto_mathslate")+'"/><math><mi>&#x2718;</mi></math></button>'),p=f.Node.create('<button type="button" class="'+E.HELP+'" title="'+M.util.get_string("help","atto_mathslate")+'"><math><mi>&#xE47C;</mi></math></button>'),o.appendChild(u),o.appendChild(c),o.appendChild(g),o.appendChild(p),g.on("click",function(){r=r.redo(),s=r.slots[0],l()}),c.on("click",function(){r=r.undo(),s=r.slots[0],l()}),u.on("click",function(){f.one(t+" "+S)?r.removeSnippet(f.one(t+" "+S).getAttribute("id")):(s=[],r.next=new v.mSlots,(r=(r.next.previous=r).next).slots.push(s)),l()}),p.on("click",function(){d.setHTML('<iframe src="'+v.help+'" style="width: '+d.getStyle("width")+'" class="'+E.HELPBOX+'"/>')}),this.render=l,this.toMathML=b,this.addMath=function(e){e&&(f.one(t+" "+S)?r.insertSnippet(f.one(t+" "+S).getAttribute("id"),r.createItem(e)):r.append(r.createItem(e)),l())},this.clear=function(){f.one(t+" "+S)?r.removeSnippet(f.one(t+" "+S).getAttribute("id")):(s=[],r.next=new v.mSlots,(r=(r.next.previous=r).next).slots.push(s)),l()},this.output=function(e){return"MathML"===e?a.get("node").one("script").getHTML():"HTML"===e?a.get("node").one("span").getHTML():"JSON"===e?f.JSON.stringify(function n(e){if("object"!=typeof e)return e;var o=e.slice(0);return o.forEach(function(e,t){"object"==typeof e&&(e[1]&&e[1]["class"]?o[t]="[]":(e[1]&&e[1].id&&delete e[1].id,e[2]&&(e[2]=n(e[2]))))}),o}(s)):r.output(e)},this.getHTML=function(){return a.get("node").one("span").getHTML()},this.redo=function(){r=r.redo(),s=r.slots[0],l()},this.undo=function(){r=r.undo(),s=r.slots[0],l()},this.makeDrops=function(){h()},l()}},"@VERSION@",{requires:["moodle-atto_mathslate-snippeteditor","dd-drop"]});